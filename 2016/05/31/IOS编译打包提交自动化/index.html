<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="This is Ding Ming's Blog on GitHub"><title>IOS编译打包提交自动化 | The Zohar</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">IOS编译打包提交自动化</h1><a id="logo" href="/.">The Zohar</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">IOS编译打包提交自动化</h1><div class="post-meta">May 31, 2016<span> | </span><span class="category"><a href="/categories/IOS/">IOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/05/31/IOS编译打包提交自动化/" href="/2016/05/31/IOS编译打包提交自动化/#comments" class="ds-thread-count"></a><div class="post-content"><p>该操作是指：首先对Xcode的Project或Workspace进行编译，编译通过的应用会生成app文件，为了提供给测试使用，我们需要将.app包转为.ipa包</p>
<p>实现方法有两种，AppleScript和Shell脚本</p>
<p>Shell脚本下一个值得参考的样例是<a href="https://github.com/webfrogs/xcode_shell" target="_blank" rel="external">webfrogs/xcode_shell</a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>工具：</p>
<ul>
<li><a href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/xcodebuild.1.html" target="_blank" rel="external">xcodebuild</a>：主要用来编译、打包成Archive和导出ipa包</li>
<li>xcrun：用于打包</li>
<li>altool：ApplicationLoader，提交应用</li>
<li>fir-cli：上传到fir</li>
<li>PlistBuddy：读写plist文件</li>
</ul>
<p><code>xcodebuild</code>和<code>xcrun</code>都来自<code>Command Line Tools</code>，需要在Xcode或终端中安装。</p>
<h2 id="Shell实现"><a href="#Shell实现" class="headerlink" title="Shell实现"></a>Shell实现</h2><ul>
<li>ipa-build：编译xcode工程并生成ipa文件</li>
<li>ipa-publish：生成符合itms—services协议的文件，并发不到服务器</li>
<li>sendEmail：stmp发布email的脚本。（可以改成Applescipt来实现）</li>
<li>sftpDownloadFile：用过sftp协议下载文件</li>
<li>sftpUploadFile：通过sftp协议上传文件</li>
<li>updateLocalIndexHtml：对索引文件进行处理（二进制文件，非shell脚本）</li>
<li>uploadItemsServicesFiles：将itms-services协议文件上传到服务器</li>
</ul>
<h3 id="ipa-build"><a href="#ipa-build" class="headerlink" title="ipa-build"></a>ipa-build</h3><ol>
<li><p>使用方法：<br> <code>ipa-build 脚本绝对路径 参数1 参数2</code></p>
<p> 参数1为IOS工程的跟路径；参数2可选，为编译是工程configuration的类型：Debug、AdHoc、Release、Distribution，默认为Release。</p>
<p> ipa-build脚本运行后，会在IOS工程根路径下生成名为“build”的文件夹，在这个文件夹中又有一个名为“ipa-build”的文件夹，打包所生成的最新ipa包就在其中。</p>
</li>
<li><p>源码分析</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="comment">#--------------------------------------------</span></span><br><span class="line"><span class="comment"># 功能：编译xcode项目并打ipa包</span></span><br><span class="line"><span class="comment"># 使用说明：</span></span><br><span class="line"><span class="comment">#		编译project</span></span><br><span class="line"><span class="comment">#			ipa-build &lt;project directory&gt; [-c &lt;project configuration&gt;] [-o &lt;ipa output directory&gt;] [-t &lt;target name&gt;] [-n] [-p &lt;platform identifier&gt;]</span></span><br><span class="line"><span class="comment">#		编译workspace</span></span><br><span class="line"><span class="comment">#			ipa-build  &lt;workspace directory&gt; -w -s &lt;schemeName&gt; [-c &lt;project configuration&gt;] [-n]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 参数说明：-c NAME				工程的configuration,默认为Release。</span></span><br><span class="line"><span class="comment">#			-o PATH				生成的ipa文件输出的文件夹（必须为已存在的文件路径）默认为工程根路径下的”build/ipa-build“文件夹中</span></span><br><span class="line"><span class="comment">#			-t NAME				需要编译的target的名称</span></span><br><span class="line"><span class="comment">#			-w					编译workspace	</span></span><br><span class="line"><span class="comment">#			-s NAME				对应workspace下需要编译的scheme</span></span><br><span class="line"><span class="comment">#			-n					编译前是否先clean工程</span></span><br><span class="line"><span class="comment">#			-p					平台标识符</span></span><br><span class="line"><span class="comment"># 作者：ccf</span></span><br><span class="line"><span class="comment"># E-mail:ccf.developer@gmail.com</span></span><br><span class="line"><span class="comment"># 创建日期：2012/09/24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数个数不能小于1</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-lt</span> 1 ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! Should enter the root directory of xcode project after the ipa-build command."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 判断第一个参数提供的目录是否存在，其他命令有-f，-s，-e</span></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! The first param must be a directory."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工程绝对路径</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$1</span></span><br><span class="line"><span class="comment"># 当前目录的全路径名称</span></span><br><span class="line">project_path=$(<span class="built_in">pwd</span>)</span><br><span class="line"><span class="comment">#编译的configuration，默认为Release</span></span><br><span class="line">build_config=Release</span><br><span class="line"><span class="comment"># 设置参数名</span></span><br><span class="line">param_pattern=<span class="string">":p:nc:o:t:ws:"</span></span><br><span class="line">OPTIND=2</span><br><span class="line"><span class="comment"># 遍历参数</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$optname</span>"</span> <span class="keyword">in</span>       </span><br><span class="line"><span class="string">"n"</span>) </span><br><span class="line"><span class="comment"># 是否清理工程</span></span><br><span class="line">should_clean=y		</span><br><span class="line">;;</span><br><span class="line"><span class="string">"p"</span>)</span><br><span class="line">tmp_optind=<span class="variable">$OPTIND</span></span><br><span class="line">tmp_optname=<span class="variable">$optname</span></span><br><span class="line">tmp_optarg=<span class="variable">$OPTARG</span></span><br><span class="line"></span><br><span class="line">OPTIND=<span class="variable">$OPTIND</span>-1</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname ;<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error argument value for option <span class="variable">$tmp_optname</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">OPTIND=<span class="variable">$tmp_optind</span></span><br><span class="line"><span class="comment"># 平台标志符</span></span><br><span class="line">platform_id=<span class="variable">$tmp_optarg</span></span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="string">"c"</span>)        </span><br><span class="line">tmp_optind=<span class="variable">$OPTIND</span></span><br><span class="line">tmp_optname=<span class="variable">$optname</span></span><br><span class="line">tmp_optarg=<span class="variable">$OPTARG</span></span><br><span class="line">OPTIND=<span class="variable">$OPTIND</span>-1</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname ;<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error argument value for option <span class="variable">$tmp_optname</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">OPTIND=<span class="variable">$tmp_optind</span></span><br><span class="line"><span class="comment"># 设定工程的configuration</span></span><br><span class="line">build_config=<span class="variable">$tmp_optarg</span></span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="string">"o"</span>)</span><br><span class="line">tmp_optind=<span class="variable">$OPTIND</span></span><br><span class="line">tmp_optname=<span class="variable">$optname</span></span><br><span class="line">tmp_optarg=<span class="variable">$OPTARG</span></span><br><span class="line"></span><br><span class="line">OPTIND=<span class="variable">$OPTIND</span>-1</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname ;<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error argument value for option <span class="variable">$tmp_optname</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">OPTIND=<span class="variable">$tmp_optind</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$tmp_optarg</span></span><br><span class="line"><span class="comment"># 输出文件夹</span></span><br><span class="line">output_path=$(<span class="built_in">pwd</span>)</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;project_path&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="variable">$output_path</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error!The value of option o must be an exist directory."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="string">"w"</span>)</span><br><span class="line">workspace_name=<span class="string">'*.xcworkspace'</span></span><br><span class="line"><span class="comment"># 查看该路径下是否有xcworkspace文件</span></span><br><span class="line">ls <span class="variable">$project_path</span>/<span class="variable">$workspace_name</span> &amp;&gt;/dev/null</span><br><span class="line">rtnValue=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$rtnValue</span> = 0 ];<span class="keyword">then</span></span><br><span class="line">build_workspace=$(<span class="built_in">echo</span> $(basename <span class="variable">$project_path</span>/<span class="variable">$workspace_name</span>))</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error!Current path is not a xcode workspace.Please check, or do not use -w option."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"><span class="string">"s"</span>)</span><br><span class="line">tmp_optind=<span class="variable">$OPTIND</span></span><br><span class="line">tmp_optname=<span class="variable">$optname</span></span><br><span class="line">tmp_optarg=<span class="variable">$OPTARG</span></span><br><span class="line"></span><br><span class="line">OPTIND=<span class="variable">$OPTIND</span>-1</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname ;<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error argument value for option <span class="variable">$tmp_optname</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">OPTIND=<span class="variable">$tmp_optind</span></span><br><span class="line"><span class="comment"># workspace下需要编译的scheme</span></span><br><span class="line">build_scheme=<span class="variable">$tmp_optarg</span></span><br><span class="line">;;</span><br><span class="line"><span class="string">"t"</span>)</span><br><span class="line">tmp_optind=<span class="variable">$OPTIND</span></span><br><span class="line">tmp_optname=<span class="variable">$optname</span></span><br><span class="line">tmp_optarg=<span class="variable">$OPTARG</span></span><br><span class="line"></span><br><span class="line">OPTIND=<span class="variable">$OPTIND</span>-1</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">getopts</span> <span class="variable">$param_pattern</span> optname ;<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span>  <span class="string">"Error argument value for option <span class="variable">$tmp_optname</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">OPTIND=<span class="variable">$tmp_optind</span></span><br><span class="line"><span class="comment"># 编译目标的名称</span></span><br><span class="line">build_target=<span class="variable">$tmp_optarg</span></span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"?"</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! Unknown option <span class="variable">$OPTARG</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line">;;</span><br><span class="line"><span class="string">":"</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! No argument value for option <span class="variable">$OPTARG</span>"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="comment"># Should not occur</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! Unknown error while processing options"</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#build文件夹路径</span></span><br><span class="line">build_path=<span class="variable">$&#123;project_path&#125;</span>/build</span><br><span class="line"><span class="comment">#生成的app文件目录</span></span><br><span class="line">appdirname=Release-iphoneos</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$build_config</span> = Debug ];<span class="keyword">then</span></span><br><span class="line">appdirname=Debug-iphoneos</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$build_config</span> = Distribute ];<span class="keyword">then</span></span><br><span class="line">appdirname=Distribute-iphoneos</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#编译后文件路径(仅当编译workspace时才会用到)</span></span><br><span class="line">compiled_path=<span class="variable">$&#123;build_path&#125;</span>/<span class="variable">$&#123;appdirname&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否clean</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$should_clean</span>"</span> = <span class="string">"y"</span> ];<span class="keyword">then</span></span><br><span class="line">xcodebuild clean -configuration <span class="variable">$&#123;build_config&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#组合编译命令</span></span><br><span class="line">build_cmd=<span class="string">'xcodebuild'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$build_workspace</span>"</span> != <span class="string">""</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#编译workspace</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$build_scheme</span>"</span> = <span class="string">""</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Error! Must provide a scheme by -s option together when using -w option to compile a workspace."</span></span><br><span class="line"><span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">build_cmd=<span class="variable">$&#123;build_cmd&#125;</span><span class="string">' -workspace '</span><span class="variable">$&#123;build_workspace&#125;</span><span class="string">' -scheme '</span><span class="variable">$&#123;build_scheme&#125;</span><span class="string">' -configuration '</span><span class="variable">$&#123;build_config&#125;</span><span class="string">' CONFIGURATION_BUILD_DIR='</span><span class="variable">$&#123;compiled_path&#125;</span><span class="string">' ONLY_ACTIVE_ARCH=NO'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment">#编译project</span></span><br><span class="line">build_cmd=<span class="variable">$&#123;build_cmd&#125;</span><span class="string">' -configuration '</span><span class="variable">$&#123;build_config&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$build_target</span>"</span> != <span class="string">""</span> ];<span class="keyword">then</span></span><br><span class="line">build_cmd=<span class="variable">$&#123;build_cmd&#125;</span><span class="string">' -target '</span><span class="variable">$&#123;build_target&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译工程</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_path</span></span><br><span class="line"><span class="variable">$build_cmd</span> || <span class="built_in">exit</span></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"><span class="comment">#进入build路径</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$build_path</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ipa-build文件夹</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="_">-d</span> ./ipa-build ];<span class="keyword">then</span></span><br><span class="line">rm -rf ipa-build</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mkdir ipa-build</span><br><span class="line"></span><br><span class="line"><span class="comment">#app文件名称</span></span><br><span class="line">appname=$(basename ./<span class="variable">$&#123;appdirname&#125;</span>/*.app)</span><br><span class="line"><span class="comment">#通过app文件名获得工程target名字</span></span><br><span class="line">target_name=$(<span class="built_in">echo</span> <span class="variable">$appname</span> | awk -F. <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="comment">#app文件中Info.plist文件路径</span></span><br><span class="line">app_infoplist_path=<span class="variable">$&#123;build_path&#125;</span>/<span class="variable">$&#123;appdirname&#125;</span>/<span class="variable">$&#123;appname&#125;</span>/Info.plist</span><br><span class="line"><span class="comment">#取版本号</span></span><br><span class="line">bundleShortVersion=$(/usr/libexec/PlistBuddy -c <span class="string">"print CFBundleShortVersionString"</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"><span class="comment">#取build值</span></span><br><span class="line">bundleVersion=$(/usr/libexec/PlistBuddy -c <span class="string">"print CFBundleVersion"</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"><span class="comment">#取displayName</span></span><br><span class="line">displayName=$(/usr/libexec/PlistBuddy -c <span class="string">"print CFBundleDisplayName"</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"><span class="comment">#IPA名称</span></span><br><span class="line">ipa_name=<span class="string">"<span class="variable">$&#123;displayName&#125;</span>_<span class="variable">$&#123;platform_id&#125;</span>_<span class="variable">$&#123;bundleShortVersion&#125;</span>_<span class="variable">$&#123;build_config&#125;</span>_<span class="variable">$&#123;bundleVersion&#125;</span>_<span class="variable">$(date +"%Y%m%d")</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$ipa_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#xcrun打包</span></span><br><span class="line">xcrun -sdk iphoneos PackageApplication -v ./<span class="variable">$&#123;appdirname&#125;</span>/*.app -o <span class="variable">$&#123;build_path&#125;</span>/ipa-build/<span class="variable">$&#123;ipa_name&#125;</span>.ipa || <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$output_path</span>"</span> != <span class="string">""</span> ];<span class="keyword">then</span></span><br><span class="line">cp <span class="variable">$&#123;build_path&#125;</span>/ipa-build/<span class="variable">$&#123;ipa_name&#125;</span>.ipa <span class="variable">$output_path</span>/<span class="variable">$&#123;ipa_name&#125;</span>.ipa</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Copy ipa file successfully to the path <span class="variable">$output_path</span>/<span class="variable">$&#123;ipa_name&#125;</span>.ipa"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="AppleScript实现"><a href="#AppleScript实现" class="headerlink" title="AppleScript实现"></a>AppleScript实现</h2><p>相比shell，appleScript的简易性以及对mac OS系统的接口支持使其能够更好的在mac下工作，虽然该语言已经渐渐被大家遗忘，但并不表示它不work，所以我打算使用applescript对上述流程进行复现，并非简单的抄袭，而是根据自身需要以及applescript的特性进行改进，部分实现如下：</p>
<p>applescript的存在形式有三种，一种是文本文件，与shell类似，在首行定义<code>#!/usr/bin/osascript</code>便可以在终端下运行；另一种是应用程序，通过双击来运行；还有一种是名为Droplet的应用程序，其特点是可以获取所有拖动到该应用图标上的文件的信息（支持多文件），于是我选择用第三种方式来传递工程路径，其他配置则设为默认值，实现一次拖动，完成自动编译和打包的过程。</p>
<h3 id="拖动操作的Handle"><a href="#拖动操作的Handle" class="headerlink" title="拖动操作的Handle"></a>拖动操作的Handle</h3><p>文件拖动到应用图标上方是通过Handle监听实现的：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> open these_items</span><br><span class="line"><span class="keyword">repeat</span> <span class="keyword">with</span> this_item <span class="keyword">in</span> these_items</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">repeat</span></span><br><span class="line"><span class="keyword">end</span> open</span><br></pre></td></tr></table></figure>
<p>每个this_item为alias类型，代表其中一个被拖进图标的文件夹。</p>
<p>待续…</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><p><a href="http://zackzheng.info/2015/12/27/2015-12-27-an-automated-script-for-building-archiving-submission-sending-emails/#" target="_blank" rel="external">详解Shell脚本实现iOS自动化编译打包提交</a></p>
</li>
<li><p><a href="http://blog.csdn.net/ccf0703/article/details/8588667" target="_blank" rel="external">IOS工程自动打包并发布脚本实现</a></p>
</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://xenobladex.github.io/2016/05/31/IOS编译打包提交自动化/" data-id="ciov8nedi0000iu2wb7crpqi6" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Applescript/">Applescript</a><a href="/tags/编译/">编译</a></div><div class="post-nav"><a href="/2016/05/31/XMPPFramework源码分析-三-流/" class="next">XMPPFramework源码分析&lt;三&gt; - 流</a></div><div data-thread-key="2016/05/31/IOS编译打包提交自动化/" data-title="IOS编译打包提交自动化" data-url="http://xenobladex.github.io/2016/05/31/IOS编译打包提交自动化/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/05/31/IOS编译打包提交自动化/" data-title="IOS编译打包提交自动化" data-url="http://xenobladex.github.io/2016/05/31/IOS编译打包提交自动化/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IOS/">IOS</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Applescript/" style="font-size: 15px;">Applescript</a> <a href="/tags/编译/" style="font-size: 15px;">编译</a> <a href="/tags/XMPP/" style="font-size: 15px;">XMPP</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/IOS编译打包提交自动化/">IOS编译打包提交自动化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/XMPPFramework源码分析-三-流/">XMPPFramework源码分析<三> - 流</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/XMPPFramework源码分析-二-JID/">XMPPFramework源码分析<二> - JID</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/XMPPFramework源码分析-一-消息/">XMPPFramework源码分析<一> - 消息</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/18/多重委托-MultiDelegate-官方解释/">多重委托(MultiDelegate)官方解释</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/18/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">The Zohar.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'xenobladex'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>